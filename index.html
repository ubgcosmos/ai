<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ai</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
  :root {
    --bg: #111;
    --text: #eee;
    --accent: #0b66ff;
    --bubble-user: #0b66ff;
    --bubble-ai: #222;
  }

  body.light {
    --bg: #fafafa;
    --text: #111;
    --bubble-user: #0b66ff;
    --bubble-ai: #e6e6e6;
  }

  body.celeste {
    --bg: #cfe9ff;
    --text: #08324a;
    --bubble-user: #6bb8ff;
    --bubble-ai: #a5d3ff;
  }

  body.midnight {
    --bg: #050712;
    --text: #d0d8ff;
    --bubble-user: #2d3a6f;
    --bubble-ai: #111a3c;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: "Poppins", sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  header {
    padding: 1rem;
    background: rgba(0,0,0,0.25);
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(5px);
  }

  #githubBox {
    position: relative;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: .4rem;
    padding: .4rem .8rem;
    border-radius: .4rem;
    background: rgba(255,255,255,0.1);
  }

  #githubBox:hover::after {
    content: "Source Code";
    position: absolute;
    top: 120%;
    left: 0;
    background: #000;
    padding: .4rem .7rem;
    border-radius: .3rem;
    color: white;
    font-size: .8rem;
    opacity: .9;
    white-space: nowrap;
  }

  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: .7rem;
  }

  .bubble {
    max-width: 70%;
    padding: .8rem 1rem;
    border-radius: 1rem;
    line-height: 1.5;
  }

  .user {
    align-self: flex-end;
    background: var(--bubble-user);
    color: #fff;
    border-bottom-right-radius: .3rem;
  }

  .ai {
    align-self: flex-start;
    background: var(--bubble-ai);
    color: var(--text);
    border-bottom-left-radius: .3rem;
  }

  .actions {
    display: flex;
    gap: .7rem;
    font-size: .8rem;
    opacity: .7;
    cursor: pointer;
  }

  #inputBar {
    padding: 1rem;
    border-top: 1px solid #333;
    display: flex;
    gap: .5rem;
  }

  #msg {
    flex: 1;
    padding: .8rem;
    border-radius: 1rem;
    border: none;
    outline: none;
    background: #222;
    color: #fff;
  }

  #send {
    padding: .8rem 1.4rem;
    border-radius: 1rem;
    border: none;
    background: var(--accent);
    color: white;
    cursor: pointer;
  }

  /* Modal */
  #nameModal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #modalBox {
    background: #222;
    padding: 2rem;
    border-radius: .8rem;
    text-align: center;
  }

  select {
    padding: .4rem;
    border-radius: .4rem;
  }
</style>
</head>

<body class="dark">

<header>
  <div><strong>AI</strong> <span style="opacity: .5">(beta)</span></div>
  <div>made by ethan</div>
  <div style="display: flex; gap: 1rem; align-items: center;">
    <select id="themeSelect">
      <option value="dark">dark</option>
      <option value="light">light</option>
      <option value="celeste">celeste</option>
      <option value="midnight">midnight sky</option>
    </select>

    <div id="githubBox" onclick="window.open('https://github.com/', '_blank')">
      <img src="https://cdn-icons-png.flaticon.com/512/25/25231.png" width="20">
      Source
    </div>
  </div>
</header>

<div id="chat"></div>

<div id="inputBar">
  <input id="msg" placeholder="send a message...">
  <button id="send">send</button>
</div>

<!-- NAME MODAL -->
<div id="nameModal">
  <div id="modalBox">
    <h2>what should we call you?</h2>
    <input id="nameInput" placeholder="your name..." style="padding:.6rem;">
    <br><br>
    <button onclick="saveName()" style="padding:.6rem 1rem;">Continue</button>
  </div>
</div>

<script>
let username = localStorage.getItem("username") || "";

if (!username) {
  document.getElementById("nameModal").style.display = "flex";
} else {
  document.getElementById("nameModal").style.display = "none";
}

function saveName() {
  const n = document.getElementById("nameInput").value.trim();
  username = n || "User";
  localStorage.setItem("username", username);
  document.getElementById("nameModal").style.display = "none";
}

document.getElementById("themeSelect").value = localStorage.getItem("theme") || "dark";
setTheme(document.getElementById("themeSelect").value);

document.getElementById("themeSelect").onchange = e => {
  setTheme(e.target.value);
};

function setTheme(t) {
  document.body.className = t;
  localStorage.setItem("theme", t);
}

function appendMessage(role, text, isHTML = false) {
  const wrap = document.createElement("div");

  const bubble = document.createElement("div");
  bubble.className = "bubble " + (role === "user" ? "user" : "ai");
  bubble.innerHTML = isHTML ? text : text.replace(/\n/g, "<br>");

  wrap.appendChild(bubble);

  const actions = document.createElement("div");
  actions.className = "actions";

  actions.innerHTML = `
    <span onclick="copyText(this)">ðŸ“‹</span>
    <span onclick="readText(this)">ðŸ”Š</span>
    <span onclick="redoMessage(this)">âŸ³</span>
  `;

  wrap.appendChild(actions);

  document.getElementById("chat").appendChild(wrap);
  document.getElementById("chat").scrollTop = chat.scrollHeight;

  return bubble;
}

function copyText(el) {
  const msg = el.parentElement.previousElementSibling.innerText;
  navigator.clipboard.writeText(msg);
}

function readText(el) {
  const msg = el.parentElement.previousElementSibling.innerText;
  const utter = new SpeechSynthesisUtterance(msg);
  speechSynthesis.speak(utter);
}

function redoMessage(el) {
  const msg = el.parentElement.previousElementSibling.innerText;
  sendMessage(msg);
}

document.getElementById("send").onclick = () => sendMessage();
document.getElementById("msg").addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});

async function sendMessage(prefilled = null) {
  const input = document.getElementById("msg");
  const text = prefilled || input.value.trim();
  if (!text) return;

  appendMessage("user", text);
  input.value = "";

  const aiBubble = appendMessage("ai", "...");

  const response = await fetch("https://ai.ethantytang11.workers.dev/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: text })
  });

  const reader = response.body.getReader();
  const decoder = new TextDecoder();

  aiBubble.innerHTML = "";

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value);

    chunk.split("\n").forEach(line => {
      if (!line.startsWith("data:")) return;
      const json = line.replace("data:", "").trim();
      if (json === "[DONE]") return;

      try {
        const parsed = JSON.parse(json);
        const content = parsed.choices[0].delta?.content;
        if (content) {
          aiBubble.innerHTML += marked.parse(content);
          hljs.highlightAll();
        }
      } catch {}
    });

    document.getElementById("chat").scrollTop = chat.scrollHeight;
  }
}
</script>

</body>
</html>
